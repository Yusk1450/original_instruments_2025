// ************************************
//曲げセンサ
//************************************
#include <WiFi.h>
#include <ArduinoOSCWiFi.h>
#include <TFT_eSPI.h>
#include <SPI.h>
#include "MedianFilterLib2.h"

#define SENSOR1
//山﨑
// #define SENSOR2
//早瀬

MedianFilter2<int> medianFilter(5);

TFT_eSPI tft = TFT_eSPI();

const int vol_pin = 34;
const int buttonPin = 13; 
const int ocButton = 12; 

int buttonState = 0;
bool currentState = true;


int currentNote = -1;
int oscNote = -1;

String ssid = "L305";
String pw = "4dp_1450";

#ifdef SENSOR1
const IPAddress ip(192, 168, 0, 101);
extern const int oscPort = 8000;
#endif
#ifdef SENSOR2
const IPAddress ip(192, 168, 0, 102);
extern const int oscPort = 8888;
#endif

const IPAddress gateway(192, 168, 0, 1);
const IPAddress subnet(255, 255, 255, 0);
const IPAddress dns(192, 168, 0, 1);


const char* oscHost = "192.168.0.20";

unsigned long wifiMillis = 0;
int wifiReconnectCount = 0;

int playMode = 2;

const uint8_t note30[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0},
  {0,0,1,1,0,0,0,0,1,1,0,0,1,0,0,0},
  {1,1,1,1,0,0,0,0,0,1,0,0,1,0,1,0},
  {0,0,0,1,0,0,0,0,0,1,0,1,1,1,1,0},
  {0,0,1,1,0,0,0,0,0,1,0,0,1,0,1,0},
  {0,0,1,0,0,1,1,0,0,1,0,0,1,0,1,0},
  {0,0,1,0,1,1,1,0,0,1,0,0,1,1,1,1},
  {0,0,1,0,0,1,0,0,0,1,0,0,1,0,1,0},
  {0,1,0,0,0,1,0,0,0,1,0,0,1,0,1,0},
  {0,1,0,0,1,0,0,0,1,1,1,0,0,0,1,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};

const uint8_t note31[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0},
  {0,0,1,0,0,0,0,1,1,0,0,1,1,0,0,0},
  {0,0,0,1,0,0,0,0,1,0,0,0,1,0,0,0},
  {0,0,0,1,1,0,0,1,1,0,0,0,1,0,0,0},
  {0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,0},
  {0,0,0,0,0,0,1,1,0,0,0,0,1,0,0,0},
  {0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0},
  {0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0},
  {0,0,0,0,1,1,0,0,0,0,0,0,1,0,0,0},
  {0,0,0,1,0,0,0,0,0,0,0,1,1,1,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};

const uint8_t note32[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0},
  {1,0,0,0,0,1,1,0,1,1,0,0,1,0,0,0},
  {0,1,0,0,0,0,1,0,0,1,0,0,1,0,1,0},
  {0,1,1,0,0,1,1,0,0,1,0,1,1,1,1,0},
  {0,0,1,0,0,1,0,0,0,1,0,0,1,0,1,0},
  {0,0,0,0,1,1,0,0,0,1,0,0,1,0,1,0},
  {0,0,0,0,1,0,0,0,0,1,0,0,1,1,1,1},
  {0,0,0,1,0,0,0,0,0,1,0,0,1,0,1,0},
  {0,0,1,1,0,0,0,0,0,1,0,0,1,0,1,0},
  {0,1,0,0,0,0,0,0,1,1,1,0,0,0,1,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};


const uint8_t note33[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,1,1,0,0,0,1,0,0,0,0},
  {0,0,0,1,1,1,1,1,0,0,1,1,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0},
  {0,0,1,0,1,1,1,1,1,0,0,1,0,0,0,0},
  {0,0,1,1,1,0,0,1,1,0,0,1,0,0,0,0},
  {0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0},
  {0,0,0,0,0,0,1,1,0,0,0,1,0,0,0,0},
  {0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0},
  {0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0},
  {0,0,0,1,1,0,0,0,0,0,1,1,1,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};

const uint8_t note34[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,1,1,0,0,0,1,0,0,0,0,0,0},
  {0,0,1,1,1,1,0,0,1,1,0,0,1,0,0,0},
  {0,0,0,0,0,0,0,0,0,1,0,0,1,0,1,0},
  {0,1,1,1,1,1,1,0,0,1,0,1,1,1,1,0},
  {0,0,1,1,0,1,1,0,0,1,0,0,1,0,1,0},
  {0,0,0,0,0,1,0,0,0,1,0,0,1,0,1,0},
  {0,0,0,0,0,1,0,0,0,1,0,0,1,1,1,1},
  {0,0,0,0,1,0,0,0,0,1,0,0,1,0,1,0},
  {0,0,0,1,1,0,0,0,0,1,0,0,1,0,1,0},
  {0,0,1,1,0,0,0,0,1,1,1,0,0,0,1,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};

const uint8_t note35[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0},
  {0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0},
  {0,0,0,0,1,1,0,0,0,0,0,0,1,0,0,0},
  {0,0,1,0,0,0,0,0,0,1,0,0,1,0,0,0},
  {0,0,0,1,1,0,0,0,1,0,0,0,1,0,0,0},
  {0,0,0,0,0,0,0,1,1,0,0,0,1,0,0,0},
  {0,0,0,0,0,0,1,1,0,0,0,0,1,0,0,0},
  {0,0,0,0,0,1,1,0,0,0,0,0,1,0,0,0},
  {0,0,1,1,1,1,0,0,0,0,0,0,1,0,0,0},
  {0,0,0,1,0,0,0,0,0,0,0,1,1,1,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};

const uint8_t note36[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,1,0,0,0,0,1,1,0,0,0,0},
  {0,0,1,0,0,0,1,0,0,1,0,0,1,1,0,0},
  {0,0,1,0,0,1,0,0,0,1,0,0,0,1,0,0},
  {0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0},
  {0,0,1,1,1,0,0,0,0,0,0,0,1,1,0,0},
  {0,0,1,0,1,1,0,0,0,0,0,0,1,0,0,0},
  {0,0,1,0,0,1,0,0,0,0,0,1,0,0,0,0},
  {0,0,1,0,0,0,0,0,0,0,1,1,0,0,0,0},
  {0,0,1,0,0,0,0,0,0,1,1,0,0,0,0,0},
  {0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0},
  {0,0,1,0,0,0,0,0,0,1,1,1,1,1,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};

const uint8_t note37[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,1,0,1,0,0,0,1,0,0,0,0,0,0,0,0},
  {0,1,0,0,1,0,1,0,1,0,0,1,0,0,0,0},
  {0,1,0,1,0,0,1,0,1,0,0,1,0,1,0,0},
  {0,1,0,0,0,0,0,0,1,0,1,1,1,1,0,0},
  {0,1,1,0,0,0,0,0,1,0,0,1,0,1,0,0},
  {0,1,1,1,0,0,0,1,1,0,0,1,0,1,0,0},
  {0,1,0,1,0,0,0,1,0,0,0,1,1,1,1,0},
  {0,1,0,0,0,0,1,0,0,0,0,1,0,1,0,0},
  {0,1,0,0,0,0,1,0,0,0,0,1,0,1,0,0},
  {0,1,0,0,0,0,1,1,1,0,0,0,0,1,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};

const uint8_t note38[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,1,1,0,0,0,0,0,0,0,1,1,0,0,0},
  {0,0,0,1,0,0,0,0,0,0,1,0,1,1,0,0},
  {0,0,0,1,0,0,0,0,0,0,1,0,0,1,0,0},
  {0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0},
  {0,0,0,1,0,0,0,1,1,0,0,0,1,1,0,0},
  {0,0,0,1,0,0,1,1,0,0,0,0,1,0,0,0},
  {0,0,0,1,0,1,1,0,0,0,0,1,0,0,0,0},
  {0,0,0,1,1,1,0,0,0,0,1,1,0,0,0,0},
  {0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};

const uint8_t note39[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0},
  {1,0,0,0,0,0,1,0,1,0,0,1,0,0,0,0},
  {1,0,0,0,0,0,1,0,1,0,0,1,0,1,0,0},
  {1,0,0,0,0,0,0,0,1,0,1,1,1,1,0,0},
  {1,0,0,0,1,0,0,0,1,0,0,1,0,1,0,0},
  {1,0,0,1,0,0,0,1,1,0,0,1,0,1,0,0},
  {1,0,1,1,0,0,0,1,0,0,0,1,1,1,1,0},
  {1,1,1,0,0,0,1,0,0,0,0,1,0,1,0,0},
  {1,1,0,0,0,0,1,0,0,0,0,1,0,1,0,0},
  {1,0,0,0,0,0,1,1,1,0,0,0,0,1,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};

const uint8_t note40[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0},
  {0,0,0,1,1,1,0,0,0,0,1,0,1,1,0,0},
  {0,0,0,0,0,1,0,0,0,0,1,0,0,1,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0},
  {0,0,0,1,1,0,0,0,0,0,0,0,1,1,0,0},
  {0,0,0,0,1,1,0,0,0,0,0,0,1,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0},
  {0,0,1,1,0,0,0,0,0,0,1,1,0,0,0,0},
  {0,0,0,0,1,1,0,0,0,0,1,0,0,0,0,0},
  {0,0,0,0,0,1,1,0,0,0,1,1,1,1,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};

const uint8_t note41[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0},
  {0,0,0,1,1,0,0,0,0,0,0,1,0,1,1,0},
  {0,1,1,1,1,0,0,0,0,0,0,1,0,0,1,0},
  {0,0,0,0,1,0,1,1,1,1,0,0,0,0,1,0},
  {0,0,0,1,1,0,1,1,1,1,0,0,0,1,1,0},
  {0,0,0,1,0,0,0,1,1,0,0,0,0,1,0,0},
  {0,0,0,1,0,0,0,1,0,0,0,0,1,0,0,0},
  {0,0,1,1,0,0,0,1,0,0,0,1,1,0,0,0},
  {0,0,1,0,0,0,0,1,0,0,0,1,0,0,0,0},
  {0,1,0,0,0,0,1,0,0,0,0,1,1,1,1,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};

const uint8_t note42[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0},
  {0,0,1,1,0,0,0,1,0,1,0,0,1,0,0,0},
  {1,1,1,1,0,0,0,1,0,1,0,0,1,0,1,0},
  {0,0,0,1,0,0,0,0,0,1,0,1,1,1,1,0},
  {0,0,1,1,0,0,0,0,0,1,0,0,1,0,1,0},
  {0,0,1,0,0,1,1,0,1,1,0,0,1,0,1,0},
  {0,0,1,0,1,1,1,0,1,0,0,0,1,1,1,1},
  {0,0,1,0,0,1,0,1,0,0,0,0,1,0,1,0},
  {0,1,0,0,0,1,0,1,0,0,0,0,1,0,1,0},
  {0,1,0,0,1,0,0,1,1,1,0,0,0,0,1,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};

const uint8_t note43[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0},
  {0,0,1,0,0,0,0,1,1,0,0,1,0,1,1,0},
  {0,0,1,1,0,0,0,1,1,0,0,1,0,0,1,0},
  {0,0,0,1,1,0,0,1,0,0,0,0,0,0,1,0},
  {0,0,0,0,1,0,0,1,0,0,0,0,0,1,1,0},
  {0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0},
  {0,0,0,0,0,1,1,0,0,0,0,0,1,0,0,0},
  {0,0,0,0,0,1,0,0,0,0,0,1,1,0,0,0},
  {0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0},
  {0,0,0,1,0,0,0,0,0,0,0,1,1,1,1,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};

const uint8_t note44[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0},
  {0,0,0,0,1,0,1,0,1,0,0,1,0,0,0,0},
  {1,0,0,1,1,0,1,0,1,0,0,1,0,1,0,0},
  {1,0,0,1,0,0,0,0,1,0,1,1,1,1,0,0},
  {0,0,0,1,0,0,0,0,1,0,0,1,0,1,0,0},
  {0,0,1,1,0,0,0,1,1,0,0,1,0,1,0,0},
  {0,0,1,0,0,0,0,1,0,0,0,1,1,1,1,0},
  {0,1,1,0,0,0,1,0,0,0,0,1,0,1,0,0},
  {0,1,0,0,0,0,1,0,0,0,0,1,0,1,0,0},
  {1,0,0,0,0,0,1,1,1,0,0,0,0,1,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};

const uint8_t note45[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,1,0,0,0,0,0,1,1,0,0},
  {0,0,0,1,1,1,1,0,0,0,0,1,0,1,1,0},
  {0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0},
  {0,0,1,0,1,1,1,1,1,0,0,0,0,0,1,0},
  {0,0,1,1,1,0,0,1,0,0,0,0,0,1,1,0},
  {0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0},
  {0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0},
  {0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0},
  {0,0,0,0,1,1,0,0,0,0,0,1,0,0,0,0},
  {0,0,0,1,1,0,0,0,0,0,0,1,1,1,1,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};

const uint8_t note46[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,1,1,0,0,1,0,0,0,0,0,0,0,0},
  {0,1,1,1,0,0,1,0,1,0,0,1,0,0,0,0},
  {0,0,0,0,0,0,1,0,1,0,0,1,0,1,0,0},
  {1,1,1,1,1,0,0,0,1,0,1,1,1,1,0,0},
  {0,1,1,0,1,0,0,0,1,0,0,1,0,1,0,0},
  {0,0,0,0,1,0,0,1,1,0,0,1,0,1,0,0},
  {0,0,0,1,1,0,0,1,0,0,0,1,1,1,1,0},
  {0,0,0,1,0,0,1,0,0,0,0,1,0,1,0,0},
  {0,0,1,1,0,0,1,0,0,0,0,1,0,1,0,0},
  {0,1,1,0,0,0,1,1,1,0,0,0,0,1,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};

const uint8_t note47[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0},
  {0,0,0,1,1,0,0,0,0,0,0,1,0,1,1,0},
  {0,0,0,0,1,1,0,0,0,0,0,1,0,0,1,0},
  {0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0},
  {0,0,0,1,0,0,0,0,1,0,0,0,0,1,1,0},
  {0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0},
  {0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0},
  {0,0,0,0,0,1,0,0,0,0,0,1,1,0,0,0},
  {0,0,1,1,1,0,0,0,0,0,0,1,0,0,0,0},
  {0,0,0,1,0,0,0,0,0,0,0,1,1,1,1,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};

const uint8_t note48[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0},
  {0,0,0,0,1,0,0,1,0,0,1,0,1,1,0,0},
  {0,0,0,0,1,0,0,0,1,0,1,0,0,1,0,0},
  {0,0,0,0,1,0,0,1,0,0,0,0,0,1,0,0},
  {0,0,0,0,1,0,0,0,0,0,0,1,1,0,0,0},
  {0,0,0,0,1,1,1,0,0,0,0,1,1,1,0,0},
  {0,0,0,0,1,0,1,1,0,0,0,0,0,1,0,0},
  {0,0,0,0,1,0,0,1,0,0,0,0,0,1,0,0},
  {0,0,0,0,1,0,0,0,0,1,1,0,0,1,0,0},
  {0,0,0,0,1,0,0,0,0,0,1,1,1,0,0,0},
  {0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};


const uint8_t note49[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,1,0,1,0,0,0,1,0,0,0,0,0,0,0,0},
  {0,1,0,1,1,0,1,0,1,0,0,1,0,0,0,0},
  {0,1,0,1,0,0,1,0,1,0,0,1,0,1,0,0},
  {0,1,0,0,0,0,0,0,1,0,1,1,1,1,0,0},
  {0,1,1,0,0,0,0,1,1,0,0,1,0,1,0,0},
  {0,1,1,1,0,0,0,1,1,0,0,1,0,1,0,0},
  {0,1,0,1,0,0,0,0,1,0,0,1,1,1,1,0},
  {0,1,0,0,0,0,0,0,1,0,0,1,0,1,0,0},
  {0,1,0,0,0,0,1,0,1,0,0,1,0,1,0,0},
  {0,1,0,0,0,0,1,1,1,0,0,0,0,1,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};
const uint8_t note50[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0},
  {0,0,0,1,0,0,0,0,0,0,0,1,0,1,1,0},
  {0,0,0,1,0,0,0,0,0,0,0,1,0,0,1,0},
  {0,0,0,1,0,0,0,0,1,0,0,0,0,0,1,0},
  {0,0,0,1,0,0,0,1,1,0,0,0,1,1,0,0},
  {0,0,0,1,0,0,1,1,0,0,0,0,1,1,1,0},
  {0,0,0,1,0,1,1,0,0,0,0,0,0,0,1,0},
  {0,0,0,1,1,1,0,0,0,0,0,0,0,0,1,0},
  {0,0,0,1,0,0,0,0,0,0,0,1,0,0,1,0},
  {0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};
const uint8_t note51[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0},
  {1,0,0,0,0,0,1,0,1,0,0,1,0,0,0,0},
  {1,0,0,0,0,0,1,0,1,0,0,1,0,1,0,0},
  {1,0,0,0,0,0,0,0,1,0,1,1,1,1,0,0},
  {1,0,0,0,1,0,0,1,1,0,0,1,0,1,0,0},
  {1,0,0,1,0,0,0,1,1,0,0,1,0,1,0,0},
  {1,0,1,1,0,0,0,0,1,0,0,1,1,1,1,0},
  {1,1,1,0,0,0,0,0,1,0,0,1,0,1,0,0},
  {1,1,0,0,0,0,1,0,1,0,0,1,0,1,0,0},
  {1,0,0,0,0,0,1,1,1,0,0,0,0,1,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};
const uint8_t note52[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0},
  {0,0,0,1,1,1,0,0,0,0,1,0,1,1,0,0},
  {0,0,0,0,0,1,0,0,0,0,1,0,0,1,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0},
  {0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0},
  {0,0,0,0,1,1,0,0,0,0,0,1,1,1,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0},
  {0,0,1,1,0,0,0,0,0,0,0,0,0,1,0,0},
  {0,0,0,0,1,1,0,0,0,0,1,0,0,1,0,0},
  {0,0,0,0,0,1,1,0,0,0,1,1,1,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};
const uint8_t note53[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0},
  {0,0,0,1,1,0,0,0,0,0,0,1,0,1,1,0},
  {0,1,1,1,1,0,0,0,0,0,0,1,0,0,1,0},
  {0,0,0,0,1,0,1,1,1,1,0,0,0,0,1,0},
  {0,0,0,1,1,0,1,1,1,1,0,0,1,1,0,0},
  {0,0,0,1,0,0,0,1,1,0,0,0,1,1,1,0},
  {0,0,0,1,0,0,0,1,0,0,0,0,0,0,1,0},
  {0,0,1,1,0,0,0,1,0,0,0,0,0,0,1,0},
  {0,0,1,0,0,0,0,1,0,0,0,1,0,0,1,0},
  {0,1,0,0,0,0,1,0,0,0,0,1,1,1,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};
const uint8_t note54[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0},
  {0,0,1,1,0,0,0,1,0,1,0,0,1,0,0,0},
  {1,1,1,1,0,0,0,1,0,1,0,0,1,0,1,0},
  {0,0,0,1,0,0,0,0,0,1,0,1,1,1,1,0},
  {0,0,1,1,0,0,0,0,1,1,0,0,1,0,1,0},
  {0,0,1,0,0,1,1,0,1,1,0,0,1,0,1,0},
  {0,0,1,0,1,1,1,0,0,1,0,0,1,1,1,1},
  {0,0,1,0,0,1,0,0,0,1,0,0,1,0,1,0},
  {0,1,0,0,0,1,0,1,0,1,0,0,1,0,1,0},
  {0,1,0,0,1,0,0,1,1,1,0,0,0,0,1,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};
const uint8_t note55[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0},
  {0,0,1,0,0,0,0,1,1,0,1,0,1,1,0,0},
  {0,0,1,1,0,0,0,1,1,0,1,0,0,1,0,0},
  {0,0,0,1,1,0,0,1,0,0,0,0,0,1,0,0},
  {0,0,0,0,1,0,0,1,0,0,0,1,1,0,0,0},
  {0,0,0,0,0,0,1,0,0,0,0,1,1,1,0,0},
  {0,0,0,0,0,1,1,0,0,0,0,0,0,1,0,0},
  {0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0},
  {0,0,0,0,1,0,0,0,0,0,1,0,0,1,0,0},
  {0,0,0,1,0,0,0,0,0,0,1,1,1,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};
const uint8_t note56[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0},
  {0,0,0,0,1,0,1,0,1,0,0,1,0,0,0,0},
  {1,0,0,1,1,0,1,0,1,0,0,1,0,1,0,0},
  {1,0,0,1,0,0,0,0,1,0,1,1,1,1,0,0},
  {0,0,0,1,0,0,0,1,1,0,0,1,0,1,0,0},
  {0,0,1,1,0,0,0,1,1,0,0,1,0,1,0,0},
  {0,0,1,0,0,0,0,0,1,0,0,1,1,1,1,0},
  {0,1,1,0,0,0,0,0,1,0,0,1,0,1,0,0},
  {0,1,0,0,0,0,1,0,1,0,0,1,0,1,0,0},
  {1,0,0,0,0,0,1,1,1,0,0,0,0,1,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};
const uint8_t note57[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,1,0,0,0,0,1,1,0,0,0},
  {0,0,0,1,1,1,1,0,0,0,1,0,1,1,0,0},
  {0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0},
  {0,0,1,0,1,1,1,1,1,0,0,0,0,1,0,0},
  {0,0,1,1,1,0,0,1,0,0,0,1,1,0,0,0},
  {0,0,0,0,0,0,0,1,0,0,0,1,1,1,0,0},
  {0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0},
  {0,0,0,0,0,1,1,0,0,0,0,0,0,1,0,0},
  {0,0,0,0,1,1,0,0,0,0,1,0,0,1,0,0},
  {0,0,0,1,1,0,0,0,0,0,1,1,1,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};
const uint8_t note58[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,1,1,0,0,1,0,0,0,0,0,0,0,0},
  {0,1,1,1,0,0,1,0,1,0,0,1,0,0,0,0},
  {0,0,0,0,0,0,1,0,1,0,0,1,0,1,0,0},
  {1,1,1,1,1,0,0,0,1,0,1,1,1,1,0,0},
  {0,1,1,0,1,0,0,1,1,0,0,1,0,1,0,0},
  {0,0,0,0,1,0,0,1,1,0,0,1,0,1,0,0},
  {0,0,0,1,1,0,0,0,1,0,0,1,1,1,1,0},
  {0,0,0,1,0,0,0,0,1,0,0,1,0,1,0,0},
  {0,0,1,1,0,0,1,0,1,0,0,1,0,1,0,0},
  {0,1,1,0,0,0,1,1,1,0,0,0,0,1,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};
const uint8_t note59[16][16] = {
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0},
  {0,0,0,1,1,0,0,0,0,0,1,0,1,1,0,0},
  {0,0,0,0,1,1,0,0,0,0,1,0,0,1,0,0},
  {0,0,1,0,0,0,0,0,1,0,0,0,0,1,0,0},
  {0,0,0,1,0,0,0,0,1,0,0,1,1,0,0,0},
  {0,0,0,0,0,0,0,1,0,0,0,1,1,1,0,0},
  {0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0},
  {0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0},
  {0,0,1,1,1,0,0,0,0,0,1,0,0,1,0,0},
  {0,0,0,1,0,0,0,0,0,0,1,1,1,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
};

const uint8_t* dotImages[30] = {
  (const uint8_t*)note30,
  (const uint8_t*)note31,
  (const uint8_t*)note32,
  (const uint8_t*)note33,
  (const uint8_t*)note34,
  (const uint8_t*)note35,
  (const uint8_t*)note36,
  (const uint8_t*)note37,
  (const uint8_t*)note38,
  (const uint8_t*)note39,
  (const uint8_t*)note40,
  (const uint8_t*)note41,
  (const uint8_t*)note42,
  (const uint8_t*)note43,
  (const uint8_t*)note44,
  (const uint8_t*)note45,
  (const uint8_t*)note46,
  (const uint8_t*)note47,
  (const uint8_t*)note48,
  (const uint8_t*)note49,
  (const uint8_t*)note50,
  (const uint8_t*)note51,
  (const uint8_t*)note52,
  (const uint8_t*)note53,
  (const uint8_t*)note54,
  (const uint8_t*)note55,
  (const uint8_t*)note56,
  (const uint8_t*)note57,
  (const uint8_t*)note58,
  (const uint8_t*)note59
};


void setup() {
  // put your setup code here, to run once:
  Serial.begin(115200);

  pinMode(buttonPin, INPUT_PULLUP);
  pinMode(ocButton, INPUT_PULLUP);

  #ifdef ESP_PLATFORM
    WiFi.disconnect(true, true);  // disable wifi, erase ap info
    delay(1000);
    WiFi.mode(WIFI_STA);
  #endif

  WiFi.config(ip, gateway, subnet, dns);
  WiFi.begin(ssid.c_str(), pw.c_str());

  unsigned long time = millis();
  Serial.print("Wifi Connecting");
  while (WiFi.status() != WL_CONNECTED) {
    Serial.print(".");
    delay(500);
    if (millis() > time + 5000)
    {
        Serial.println("retry");
        WiFi.disconnect();
        WiFi.reconnect();
        time = millis();
    }
  }

  OscWiFi.subscribe(oscPort, "/playMode", onOscPlayModeReceived);

  tft.begin();
  tft.setRotation(0);
  tft.fillScreen(TFT_WHITE);

  Serial.println("Setup OK.");

}

void loop() {
  OscWiFi.update();

  buttonState = digitalRead(buttonPin);
  // put your main code here, to run repeatedly:
    if (WiFi.status() != WL_CONNECTED && millis() - wifiMillis >= 1000)
  {
    WiFi.disconnect();
    WiFi.reconnect();
    wifiMillis = millis();
    Serial.println("reconnect");
    wifiReconnectCount++;

    if (wifiReconnectCount > 10)
    {
        ESP.restart();
    }
  }

  int sensorValue = analogRead(vol_pin);
  int medianValue = medianFilter.AddValue(sensorValue);
  int note = -1;

  #ifdef SENSOR1
  if (playMode == 1)
  {
    note = map(medianValue, 2600, 3400, 41, 50);
    //クランプ
    if (note < 41) note = 41;
    if (note > 50) note = 50;
  }
  if (playMode == 2)
  {
    note = map(medianValue, 2600, 3400, 31, 39);
    if (note < 31) note = 31;
    if (note > 39) note = 39;
  }
  if (playMode == 3)
  {
    note = map(medianValue, 2600, 3400, 40, 48);
    if (note < 40) note = 40;
    if (note > 48) note = 48;
  }

  int index = note - 30;
  Serial.println(note);

  #endif

  #ifdef SENSOR2
  if (playMode == 1)
  {
    note = map(sensorValue, 2600, 3900, 50, 59);
    // クランプ
    if (note < 50) note = 50;
    if (note > 59) note = 59;
  }
  if (playMode == 2)
  {
    note = map(sensorValue, 2600, 3900, 40, 49);
    if (note < 40) note = 40;
    if (note > 49) note = 49;
  }
  if (playMode == 3)
  {
    note = map(sensorValue, 2600, 3900, 30, 39);
    if (note < 30) note = 30;
    if (note > 39) note = 39;
  }

  int index = note - 30;
  Serial.println(note);
  #endif



// int note = -1;


// if (ocButton == HIGH)
// {
//   note = map(sensorValue, 2500, 3200, 31, 39);
//   if (note < 31) note = 31;
//   if (note > 39) note = 39;
//   Serial.println(note);
// }
// else if (ocButton == LOW)
// {
//   note = map(sensorValue, 2500, 3200, 40, 49);
//   if (note < 40) note = 40;
//   if (note > 49) note = 49;
//   Serial.println(note);
// }
//   int index = note - 31;
//   Serial.println(note);

  

  if (currentNote != note)
  {
     displayDotImage(index);
  }
  currentNote = note;
  Serial.println(sensorValue);
 

  if (buttonState == HIGH && !currentState) {
    Serial.println("ON");
    oscNote = note;
    OscWiFi.send(oscHost, oscPort, "/note", oscNote);
    currentState = true;

  } else if (buttonState == LOW && currentState) {
    Serial.println("OFF");
    OscWiFi.send(oscHost, oscPort, "/off", oscNote);
    currentState = false;
  }

  delay(10);

}

void displayDotImage(int index){
  tft.fillScreen(TFT_WHITE); 

  int pixelSize = 12; // 1マスの大きさ
  int offsetX = (240 - 16 * pixelSize) / 2; // 中央寄せ
  int offsetY = (240 - 16 * pixelSize) / 2;
  const uint8_t (*img)[16] = (const uint8_t (*)[16])dotImages[index];

  for (int y = 0; y < 16; y++) {
    for (int x = 0; x < 16; x++) {
      if (img[y][x]) {
        tft.fillRect(offsetX + x * pixelSize, offsetY + y * pixelSize, pixelSize, pixelSize, TFT_BLACK);
      }
    }
  }
}

void onOscPlayModeReceived(const OscMessage& m)
{
  playMode = m.arg<int>(0);
  Serial.print(playMode);
}
